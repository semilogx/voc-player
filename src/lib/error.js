import Clappr from "clappr";

export default class ErrorPlugin extends Clappr.ContainerPlugin {
  get name() { return 'error_plugin' }
  get background() {
    return "/player/assets/no_stream_error.png";
    // return "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20height%3D%22603.01%22%20width%3D%22800%22%3E%3Cg%20transform%3D%22scale(2.28586)%22%3E%3Cpath%20d%3D%22M58.72%20245.007c-21.24-2.705-38.686-20.424-42.651-41.126-4.99-23.232.324-50.79%2020.803-65.012%203.426-1.999%208.076-5.074%201.065-3.716-14.597.209-28.962-6.918-37.937-18.137%202.66-1.569%206.848-9.055%209.953-5.947%208.74%2011.832%2026.735%2018.174%2039.886%2010.478%2011.981-6.849%2011.793-25.944.665-33.832-12.796-10.76-31.968-14.289-39.99-30.347C4.711%2044.575%209.04%2026.78%2023.04%2021.588c6.48-2.313%2012.99-3.675%2019.696-2.694%208.262%201.349%2017.383%204.841%2022.224%2011.977-2.16%202.034-5.261%2010.162-8.193%206.188-8.56-9.104-25.143-11.282-34.431-2.276-5.688%207.492-3.499%2019.347%204.178%2024.772%2012.382%2010.755%2031.337%2013.509%2039.63%2028.988%204.456%208.038%204.31%2018.022%202.05%2026.686-1.382%206.06-6.285%2010.264-9.954%2014.604%2011.453-.235%2023.456-.749%2033.76%205.13%2019.492%209.094%2029.476%2031.203%2029.231%2051.981.732%2021.693-9.986%2045.112-30.735%2053.968-9.864%204.762-21.085%205.392-31.776%204.095zm17.925-10.558c21.542-4.884%2034.955-27.735%2033.426-48.983.103-21.474-15.901-43.436-38.13-45.546-19.65-2.582-38.32%2011.89-43.932%2030.383-3.162%208.993-2.614%2018.88-1.646%2028.18%203.56%2020.39%2022.134%2038.891%2043.602%2036.607%202.256-.094%204.514.149%206.68-.64zm66.546%207.781c-.309-36.452.058-73.028.009-109.527%204.685.701%2011.476-2.57%2013.663%203.335%2020.474%2029.034%2041.017%2058.02%2061.447%2087.085%202.057-4.462.33-10.705.915-15.858l.135-74.562c3.466%201.03%2011.906-2.983%2011.04%203.078v106.123c-3.61.628-10.438%202.296-12.851-1.473-20.958-29.248-41.422-58.855-62.406-88.083-1.76%203.761-.271%209.873-.794%2014.53l-.27%2075.585c-3.473-.256-7.899.717-10.888-.233zm115.262.18c-.497-36.42-.07-73.223-.213-109.79-4.1-.886-8.85.136-8.626-6.103-9.435-34.47-19.335-68.905-28.567-103.414%201.183-1.598%2010.927-2.53%2011.802.66%208.069%2029.303%2015.43%2059.08%2023.86%2088.1%202.63.705%201.92-7.044%203.5-9.56%206.652-26.862%2013.473-53.743%2020.127-80.496%203.512%201.176%2010.85-2.44%2011.03%202.912%206.75%2028.061%2013.636%2056.143%2020.321%2084.172%201.723%207.821%203.4-1.252%204.225-4.519%207.695-27.503%2014.883-55.248%2023.006-82.55%202.976%201.182%2012.299-2.568%2010.922%202.276-9.988%2035.83-19.963%2071.647-29.858%20107.458-3.24.07-9.492%201.808-11.608-.806-7.52-29.052-14.732-58.075-22.49-87.007-2.69%202.035-2.33%207.844-3.818%2011.37-6.517%2025.302-13.148%2050.712-19.415%2075.99%202.009%202.969%209.897.482%2014.19%201.332l30.659.112c.963%203.633%204.002%2012.182-2.74%2010.093-11.654.232-23.61-.259-35.08.414-.494%2012.265-.325%2025.149-.067%2037.51%2011.028.696%2022.779.097%2034.083.299-.948%203.888%202.532%2012.24-4.377%2010.12-9.905.368-20.265-.344-29.899.672.249%2013.382-.492%2027.12.368%2040.28%2012.535%201.08%2025.97.25%2038.852.595%205.61-1.37%202.26%206.172%202.056%209.373-4.157%201.671-10.428.246-15.403.72-12.247-.142-24.741.284-36.84-.214zm-154.21-110.347c-.289-32.806-.243-65.946-.403-98.88l-24-.32c.72-4.167-1.108-12.817%205.51-10.893%2017.51.136%2035.33-.472%2052.65.125-.364%203.127%203.852%2010.484-.46%2010.928-7.263.261-14.958-.519-21.956.384-.895%2017.232-.13%2035.152-.384%2052.65v45.546c-3.5.745-7.356.208-10.958.46zm53.008-.207c-.296-36.607-.056-73.37-.13-110.037l49.39.164c.329%203.912%204.128%2012.222-2.87%2010.257-11.76.228-23.815-.252-35.394.41-.48%2012.135-.347%2024.956-.068%2037.138%2011.247.555%2022.842.278%2034.222.515-.813%203.88%202.96%2012.265-4.024%2010.08-9.94.268-20.318-.525-29.992.384-.896%2013.212-.128%2027.114-.384%2040.591%209.52%201.5%2022.463-.14%2029.273.621%206.81.76%2012.452-2.205%2013.21%201.677-.135%205.062-.385%2010.382-6.924%208.28-15.396-.096-31.106.363-46.309-.08z%22%20fill%3D%22%23fff%22%2F%3E%3Ccircle%20r%3D%226.253%22%20cy%3D%22129.087%22%20cx%3D%22335.89%22%20fill%3D%22%23cb517b%22%20stroke%3D%22%23000%22%20stroke-width%3D%22.083%22%20stroke-miterlimit%3D%223.916%22%20stroke-opacity%3D%22.996%22%2F%3E%3Cpath%20d%3D%22M175.018.012C97.591.012%2034.803%2062.788%2034.803%20140.215a140.208%20140.208%200%20009.157%2049.693c2.057-5.376%204.413-10.616%207.375-15.556%201.516-2.506%203.182-4.933%204.282-7.64%201.113-2.702%201.627-5.761.781-8.566a14.729%2014.729%200%2000-2.382-4.368c-.99-1.327-2.076-2.596-2.968-4.002a17.97%2017.97%200%2001-2.76-12.106%2016.22%2016.22%200%20016.275-10.674c3.026-2.252%206.866-3.255%2010.648-3.125a19.005%2019.005%200%20013.742.521c4.888%201.191%209.217%204.257%2012.412%208.116%203.984%204.836%206.314%2010.922%206.893%2017.15a38.648%2038.648%200%2001-2.975%2018.31c-4.328%2010.328-12.43%2018.653-16.922%2028.904-3.658%208.383-4.706%2017.716-4.218%2026.854.072.834.196%201.673.267%202.532a140.208%20140.208%200%200039.15%2034.385%20190.657%20190.657%200%2001-1.406-22.819c.02-6.053.325-12.106.917-18.113-3.677-2.552-7.029-5.513-9.404-9.301-4.244-6.704-5.045-15.224-3.3-22.969%201.731-7.745%205.838-14.814%2010.778-21.03a84.71%2084.71%200%200130.655-24.042%20111.44%20111.44%200%2001-.97-1.367%2052.492%2052.492%200%2001-7.588-23.529c-.65-8.396.69-16.805%201.243-25.194.397-5.871.43-11.735.755-17.593.41-6.782%201.236-13.577%203.137-20.099a25.52%2025.52%200%20012.877-6.808%2015.139%2015.139%200%20016.424-5.558%2014.84%2014.84%200%20018.396-.944c2.375.495%204.595%201.692%206.528%203.183%201.946%201.49%203.625%203.287%205.187%205.155a78.923%2078.923%200%200111.247%2017.488%2038.61%2038.61%200%200111.794%200%2078.806%2078.806%200%200111.247-17.475%2034.717%2034.717%200%20015.187-5.149c1.953-1.516%204.14-2.681%206.535-3.189a13.714%2013.714%200%20018.435.93%2015.165%2015.165%200%20016.43%205.592c1.341%202.05%202.187%204.413%202.877%206.769%201.894%206.508%202.727%2013.297%203.137%2020.072.326%205.871.358%2011.755.755%2017.606.54%208.396%201.894%2016.805%201.256%2025.188a52.505%2052.505%200%2001-7.62%2023.562c-.327.54-.763%201.041-1.114%201.562%202.668%203.013%206.463%205.552%209.71%206.638a21.153%2021.153%200%200011.352.482%2017.847%2017.847%200%20005.766-2.447%2013.55%2013.55%200%20004.296-4.517c1.276-2.272%201.79-4.869%202.076-7.433.716-6.593%200-13.232-.546-19.838-.365-4.283-.67-8.657.292-12.842.651-2.811%201.914-5.597%204.036-7.57a11.963%2011.963%200%20015.031-2.752%2014.189%2014.189%200%20015.728-.326%2015.087%2015.087%200%200110.25%206.424c1.302%201.946%202.103%204.218%202.578%206.528.475%202.304.65%204.654.781%207.01.43%208.22.43%2016.46.195%2024.7-.195%207.192-.598%2014.58-3.462%2021.16-3.71%208.461-11.163%2014.774-19.2%2019.317a76.261%2076.261%200%2001-17.17%206.997c5.207%2016.656%207.927%2035.036%207.927%2053.722a190.331%20190.331%200%2001-1.458%2022.982%20140.195%20140.195%200%200069.037-120.604C315.174%2062.775%20252.385%200%20174.966%200zm-39.235%20172.83v16.037a20.333%2020.333%200%200111.715%203.919%2018.797%2018.797%200%20016.014%207.354c1.315%202.916%201.79%206.229%201.25%209.386a16.141%2016.141%200%2001-3.586%207.654%2017.814%2017.814%200%2001-6.867%204.953%2018.797%2018.797%200%2001-8.513%201.321V263.8l83.941-45.502-83.94-45.462z%22%20fill%3D%22%23fff%22%20fill-opacity%3D%22.21%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E";
  }

  constructor(...options) {
    super(...options);
    this.timeout = 1;
    this.max_timeout = 10;
  }

  bindEvents() {
    this.listenTo(this.container, Clappr.Events.CONTAINER_ERROR, this.onError)
  }

  hide() {
    this._err && this._err.remove()
  }

  show(options) {
    const $ = Clappr.$
    this.hide();

    const title = options && options.title || "Oh no, we encountered an error";
    const subtitle = options && options.subtitle || "Please reload the page";

    this._err = $('<div>')
      .css({
        'position': 'absolute',
        'z-index': '999',
        'width': '100%',
        'height': '100%',
        'background-image': 'url("' + this.background + '")',
        'background-size': '100%',
        'background-repeat': 'no-repeat',
        'background-color': 'black',
        // 'background-position': 'center 27%',
        'text-align': 'center',
        'font-family': 'bio-sans, rig-solid-bold-inline-solo, sans-serif',
        'font-weight': 'bold',
        'color': '#cb517b'
      })
    const wrap = $('<div>').css({
        'position': 'absolute',
        'width': '100%',
        'padding-bottom': '5%',
        'bottom': 0
      })
      .append($('<h2>')
        .text(title)
        .css({
          'font-size': '2em',
        }))
      .append($('<p>').text(subtitle)
        .css({
          'font-size': '1.2em',
          'margin': '15px',
        }));
    // this._err.append(wrap);
    this.container && this.container.$el.prepend(this._err);
  }

  onError(err) {
    if (!this.container) return;

    const hideOverlay = () => {
      this.hide();
      this.container.getPlugin('click_to_pause').enable();
    };

    // Only show overlay if callback returns true
    const callback = this.options.errorPlugin.onError;
    let opts = null;
    if (callback && typeof(callback) === "function") {
      opts = callback(err, hideOverlay);
    }

    this.show(opts);
    this.container.getPlugin('click_to_pause').disable();
  }
};
